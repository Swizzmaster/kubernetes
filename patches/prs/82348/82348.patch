From 498035602452639696c7b72514807c2bb458db13 Mon Sep 17 00:00:00 2001
From: Joe Betz <jpbetz@google.com>
Date: Wed, 4 Sep 2019 13:48:49 -0700
Subject: [PATCH 1/2] Add etcd image version to kubeadm

---
 cmd/kubeadm/app/constants/constants.go | 6 +++++-
 cmd/kubeadm/app/images/images.go       | 2 +-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/cmd/kubeadm/app/constants/constants.go b/cmd/kubeadm/app/constants/constants.go
index 83f3bb6389e56..209568e9b3426 100644
--- a/cmd/kubeadm/app/constants/constants.go
+++ b/cmd/kubeadm/app/constants/constants.go
@@ -262,6 +262,10 @@ const (
 	// DefaultEtcdVersion indicates the default etcd version that kubeadm uses
 	DefaultEtcdVersion = "3.3.10"
 
+	// DefaultEtcdImageVersion indicates the etcd image version that kubeadm uses.
+	// For example, the image version of "k8s.gcr.io/etcd:3.3.15-0" is "0".
+	DefaultEtcdImageVersion = "0"
+
 	// PauseVersion indicates the default pause image version for kubeadm
 	PauseVersion = "3.1"
 
@@ -425,7 +429,7 @@ var (
 		14: "3.3.10",
 		15: "3.3.10",
 		16: "3.3.10",
-		17: "3.3.10",
+		17: "3.3.15-0",
 	}
 
 	// KubeadmCertsClusterRoleName sets the name for the ClusterRole that allows
diff --git a/cmd/kubeadm/app/images/images.go b/cmd/kubeadm/app/images/images.go
index 33ca05015a616..de5fb48125070 100644
--- a/cmd/kubeadm/app/images/images.go
+++ b/cmd/kubeadm/app/images/images.go
@@ -68,7 +68,7 @@ func GetEtcdImage(cfg *kubeadmapi.ClusterConfiguration) string {
 		etcdImageRepository = cfg.Etcd.Local.ImageRepository
 	}
 	// Etcd uses an imageTag that corresponds to the etcd version matching the Kubernetes version
-	etcdImageTag := constants.DefaultEtcdVersion
+	etcdImageTag := fmt.Sprintf("%s-%s", constants.DefaultEtcdVersion, constants.DefaultEtcdImageVersion)
 	etcdVersion, err := constants.EtcdSupportedVersion(cfg.KubernetesVersion)
 	if err == nil {
 		etcdImageTag = etcdVersion.String()

From ea4a0968449d9658fef03212d5d3ccffde899df1 Mon Sep 17 00:00:00 2001
From: Joe Betz <jpbetz@google.com>
Date: Wed, 4 Sep 2019 15:37:14 -0700
Subject: [PATCH 2/2] Simplify etcd image version usage in kubeadm

---
 cmd/kubeadm/app/constants/constants.go | 8 ++------
 cmd/kubeadm/app/images/images.go       | 2 +-
 2 files changed, 3 insertions(+), 7 deletions(-)

diff --git a/cmd/kubeadm/app/constants/constants.go b/cmd/kubeadm/app/constants/constants.go
index 209568e9b3426..8cd287f31e390 100644
--- a/cmd/kubeadm/app/constants/constants.go
+++ b/cmd/kubeadm/app/constants/constants.go
@@ -260,11 +260,7 @@ const (
 	MinExternalEtcdVersion = "3.2.18"
 
 	// DefaultEtcdVersion indicates the default etcd version that kubeadm uses
-	DefaultEtcdVersion = "3.3.10"
-
-	// DefaultEtcdImageVersion indicates the etcd image version that kubeadm uses.
-	// For example, the image version of "k8s.gcr.io/etcd:3.3.15-0" is "0".
-	DefaultEtcdImageVersion = "0"
+	DefaultEtcdVersion = "3.3.15-0"
 
 	// PauseVersion indicates the default pause image version for kubeadm
 	PauseVersion = "3.1"
@@ -428,7 +424,7 @@ var (
 		13: "3.2.24",
 		14: "3.3.10",
 		15: "3.3.10",
-		16: "3.3.10",
+		16: "3.3.15-0",
 		17: "3.3.15-0",
 	}
 
diff --git a/cmd/kubeadm/app/images/images.go b/cmd/kubeadm/app/images/images.go
index de5fb48125070..33ca05015a616 100644
--- a/cmd/kubeadm/app/images/images.go
+++ b/cmd/kubeadm/app/images/images.go
@@ -68,7 +68,7 @@ func GetEtcdImage(cfg *kubeadmapi.ClusterConfiguration) string {
 		etcdImageRepository = cfg.Etcd.Local.ImageRepository
 	}
 	// Etcd uses an imageTag that corresponds to the etcd version matching the Kubernetes version
-	etcdImageTag := fmt.Sprintf("%s-%s", constants.DefaultEtcdVersion, constants.DefaultEtcdImageVersion)
+	etcdImageTag := constants.DefaultEtcdVersion
 	etcdVersion, err := constants.EtcdSupportedVersion(cfg.KubernetesVersion)
 	if err == nil {
 		etcdImageTag = etcdVersion.String()
