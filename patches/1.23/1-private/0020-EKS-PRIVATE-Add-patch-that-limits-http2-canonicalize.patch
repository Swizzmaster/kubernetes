From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Josselin Costanzi <costanzj@amazon.com>
Date: Wed, 8 Jun 2022 22:18:43 +0000
Subject: [PATCH] --EKS-PRIVATE-- Add patch that limits http2 canonicalized
 headers cache size

Related: https://code.amazon.com/packages/GoLang/commits/2930a16312c510134f182242be721679e3f083a1#
---
 vendor/golang.org/x/net/http2/server.go | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/vendor/golang.org/x/net/http2/server.go b/vendor/golang.org/x/net/http2/server.go
index 4eb7617fa0d..dabcf5afa39 100644
--- a/vendor/golang.org/x/net/http2/server.go
+++ b/vendor/golang.org/x/net/http2/server.go
@@ -790,7 +790,8 @@ func (sc *serverConn) canonicalHeader(v string) string {
 	}
 	cv = http.CanonicalHeaderKey(v)
 	size := 100 + len(v)*2 // 100 bytes of map overhead + key + value
-	if sc.canonHeaderKeysSize+size <= maxCachedCanonicalHeadersKeysSize {
+	const maximumCachedCanonicalHeadersKeysSize = 1 << 10
+	if sc.canonHeaderKeysSize+size <= maxCachedCanonicalHeadersKeysSize && len(cv) < maximumCachedCanonicalHeadersKeysSize {
 		sc.canonHeader[v] = cv
 		sc.canonHeaderKeysSize += size
 	}
